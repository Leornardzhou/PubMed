---
title: "pmRetract PubMed retractions report <br />compiled `r Sys.time()`"
author: "Neil Saunders"
date: 
output: html_document
---

```{r echo=FALSE, ref.label="setup", message=FALSE}
```

## Introduction
This is the latest report on retracted publications in the [PubMed database](http://www.pubmed.org). It was generated on `r 
strftime(Sys.Date(), "%B %d %Y")`. This report replaces the application PMRetract, formerly hosted by Heroku.

## 1. Timeline of retractions
This chart shows the number of retracted publications per year. PubMed uses a variety of different dates; the year used here is the date that the record was created (CRDT).

Clicking on a year will open a new window at PubMed showing the retracted articles for that year.

```{r chart1, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
dates <- xpathSApply(doc, "//PubmedData/History/PubMedPubDate[@PubStatus='entrez']/Year", xmlValue)
#dates <- as.Date(dates, "%Y%m%d")
df1 <- as.data.frame(table(dates), stringsAsFactors = FALSE)

h1 <- Highcharts$new()
h1$title(text = "Retracted publications by year of Entrez record creation")
h1$series(data = df1$Freq, type = "column")
h1$xAxis(categories = df1$dates, labels = list(rotation = 90, formatter = "#! function() { return '<a href=\"http://www.pubmed.org/?term=%22Retracted Publication%22[PTYP] AND ' + escape(this.value) + '[CRDT]\" target=\"_blank\">' + this.value + '</a>'; } !#", useHTML = "true"), title = list(text = "year"))
h1$yAxis(title = list(text = "retracted publications"))
h1$legend(enabled = FALSE)
h1$tooltip(pointFormat = "{point.y} records")
h1$show('inline', cdn = FALSE, include_assets = TRUE)
```

## 2. Cumulative timeline of retractions
This chart shows the cumulative sum of retracted publications per year. The year used here is the date that the record was created (CRDT).

Clicking on a year will open a new window at PubMed showing the retracted articles from 1959 up to and including that year.

```{r chart2, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
h2 <- Highcharts$new()
h2$title(text = "Cumulative sum of retracted publications by year of Entrez record creation")
h2$series(data = cumsum(df1$Freq), type = "column")
h2$xAxis(categories = df1$dates, labels = list(rotation = 90, formatter = "#! function() { return '<a href=\"http://www.pubmed.org/?term=%22Retracted Publication%22[PTYP] AND 1959:' + escape(this.value) + '[CRDT]\" target=\"_blank\">' + this.value + '</a>'; } !#", useHTML = "true"), title = list(text = "year"))
h2$yAxis(title = list(text = "sum of retracted publications"))
h2$legend(enabled = FALSE)
h2$tooltip(pointFormat = "{point.y} records since 1959")
h2$show('inline', cdn = FALSE, include_assets = TRUE)
```

## 3. Retraction rate by year
This chart shows the rate of retracted publications per year, as retractions per 100 000 publications. The year used here is the publication date (DP or PDAT).

Clicking on a year will open a new window at PubMed showing the retracted articles published in that year.

```{r chart3, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
h3 <- Highcharts$new()
h3$title(text = "Retracted publications per 100 000 publications by year of publication")
h3$series(data = as.numeric(sprintf("%.3f", (100000 / y$total) * y$retracted)), type = "column", events = list(click = "#! function() {window.open(this.options.url)} !#"))
h3$xAxis(categories = y$year, labels = list(rotation = 90, formatter = "#! function() { return '<a href=\"http://www.pubmed.org/?term=%22Retracted Publication%22[PTYP] AND ' + escape(this.value) + '[DP]\" target=\"_blank\">' + this.value + '</a>'; } !#", useHTML = "true"), title = list(text = "year"))
h3$yAxis(title = list(text = "retracted publications per 100 000 publications"))
h3$legend(enabled = FALSE)
h3$tooltip(pointFormat = "{point.y} retracted records per 100 000 publication records")
h3$show('inline', cdn = FALSE, include_assets = TRUE)
```


## 4. Retractions by Journal
This chart shows the top 20 journals by number of retracted articles.

Clicking on a journal name will open a new window at PubMed showing the retracted articles from that journal.

```{r chart4, message=FALSE, echo=FALSE, results='asis', warning=FALSE}
journals <- xpathSApply(doc, "//MedlineCitation/Article/Journal/ISOAbbreviation", xmlValue)
journals.cnt <- as.data.frame(table(journals), stringsAsFactors = FALSE)
colnames(journals.cnt) <- c("journal", "count")
j20 <- head(journals.cnt[order(journals.cnt$count, decreasing = TRUE),], 20)
h4 <- Highcharts$new()
h4$chart(marginLeft = 220)
h4$series(data = j20$count, type = "bar")
h4$xAxis(categories = j20$journal, labels = list(formatter = "#! function() { return '<a href=\"http://www.pubmed.org/?term=%22Retracted Publication%22[PTYP] AND %22' + escape(this.value) + '%22[JOUR]\" target=\"_blank\">' + this.value + '</a>'; } !#", useHTML = "true"))
h4$yAxis(title = list(text = "retracted publications"))
h4$legend(enabled = FALSE)
h4$show('inline', cdn = FALSE, include_assets = TRUE)
```

## 5. Functions

### 5.1 Setup
```{r setup, tidy=TRUE, warning=FALSE, cache=TRUE, eval=FALSE}
library(rCharts)
library(rentrez)
library(XML)
library(lubridate)

setwd("~/Dropbox/projects/pubmed/retractions/data")
doc <- xmlTreeParse("retracted.xml", useInternalNodes = TRUE)
y <- read.csv("years.csv")
```

### 5.2 Timeline

### 5.3 By Year

### 5.4 Cumulative

### 5.5 By Journal
